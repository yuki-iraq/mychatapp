<!DOCTYPE html>
<html lang="ar">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>MyChatApp</title>

<!-- Firebase -->
<script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-app-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-auth-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-firestore-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-storage-compat.js"></script>

<style>
*{box-sizing:border-box}
body{margin:0;font-family:Arial;background:#0e1621;color:white;overflow:hidden;}
.page{position:fixed;inset:0;display:none;flex-direction:column;}
.page.active{display:flex;}
.login-box{width:90%;max-width:360px;background:#17212b;padding:25px;border-radius:12px;text-align:center;margin:auto}
.login-box button,input{width:100%;padding:12px;margin-top:10px;border:none;border-radius:8px}
button{background:#2aabee;color:white}

/* Ø§Ù„Ù‚ÙˆØ§Ø¦Ù… ÙˆØ§Ù„Ø´Ø§Øª */
.top{height:55px;background:#17212b;display:flex;align-items:center;justify-content:space-between;padding:0 12px}
#list{flex:1;overflow:auto}
.chat-item{display:flex;align-items:center;padding:10px;border-bottom:1px solid #1f2c3a;cursor:pointer}
.avatar{width:45px;height:45px;border-radius:50%;background:#2aabee;margin-left:10px}
#messages{flex:1;overflow:auto;padding:10px}
.msg{max-width:75%;padding:8px;margin:5px 0;border-radius:8px;background:#182533;word-wrap:break-word;}
.me{background:#2aabee;margin-left:auto}
.msg img{max-width:100%;border-radius:8px}

/* Ø¥Ø¯Ø®Ø§Ù„ */
.input-bar{display:flex;padding:8px;background:#17212b;gap:5px}
.input-bar input[type=text]{flex:1;padding:10px;border:none;border-radius:8px}

/* Ù…Ø¹Ø§ÙŠÙ†Ø© ØµÙˆØ±Ø© */
#preview{display:flex;padding:5px}
#preview img{width:70px;border-radius:8px}

/* Ø¥Ø¹Ø¯Ø§Ø¯Ø§Øª */
#settingsPanel{position:fixed;top:60px;right:10px;background:#17212b;border-radius:10px;padding:10px;display:none}
#settingsPanel button{background:none;border:none;color:white;display:block;margin:5px 0}

/* Ù…Ù„Ù Ø´Ø®ØµÙŠ */
#profilePage{padding:20px;text-align:center}
.profile-img{width:100px;height:100px;border-radius:50%;background:#2aabee;margin:auto;background-size:cover;background-position:center}
textarea,input{width:100%;margin-top:10px;padding:10px;border:none;border-radius:8px}
.danger{background:#f55;color:white}
</style>
</head>

<body>

<!-- ØµÙØ­Ø© ØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ø¯Ø®ÙˆÙ„ -->
<div id="page-login" class="page active">
  <div class="login-box">
    <h3>ØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ø¯Ø®ÙˆÙ„</h3>
    <button onclick="loginGoogle()">ØªØ³Ø¬ÙŠÙ„ Ø¯Ø®ÙˆÙ„ Google</button>
  </div>
</div>

<!-- ØµÙØ­Ø© Ø¥Ø¯Ø®Ø§Ù„ Ø§Ù„Ø§Ø³Ù… Ù„Ø£ÙˆÙ„ Ù…Ø±Ø© -->
<div id="page-setup-name" class="page">
  <div class="login-box">
    <h3>Ø£Ø¯Ø®Ù„ Ø§Ø³Ù…Ùƒ</h3>
    <input id="nameInput" placeholder="Ø§Ø³Ù…Ùƒ">
    <button onclick="submitName()">Ø­ÙØ¸ Ø§Ù„Ø§Ø³Ù…</button>
  </div>
</div>

<!-- ØµÙØ­Ø© Ù‚Ø§Ø¦Ù…Ø© Ø§Ù„Ù…Ø­Ø§Ø¯Ø«Ø§Øª -->
<div id="page-list" class="page">
  <div class="top">
    <strong>MyChatApp</strong>
    <span onclick="toggleSettings()">âš™ï¸</span>
  </div>
  <div id="list"></div>
</div>

<!-- ØµÙØ­Ø© Ø§Ù„Ø´Ø§Øª -->
<div id="page-chat" class="page">
  <div class="top">
    <span onclick="showPage(listPage)">â¬…</span>
    <strong>Ø§Ù„Ø¯Ø±Ø¯Ø´Ø©</strong>
  </div>
  <div id="messages"></div>
  <div class="input-bar">
    <input type="file" id="imgInput" hidden accept="image/*">
    <button onclick="imgInput.click()">ğŸ“·</button>
    <input type="text" id="msg" placeholder="Ø§ÙƒØªØ¨ Ø±Ø³Ø§Ù„Ø©...">
    <button onclick="send()">â¤</button>
  </div>
  <div id="preview"></div>
</div>

<!-- ØµÙØ­Ø© Ø§Ù„Ù…Ù„Ù Ø§Ù„Ø´Ø®ØµÙŠ -->
<div id="page-profile" class="page">
  <div class="top">
    <span onclick="showPage(listPage)">â¬…</span>
    <strong>Ù…Ù„ÙÙŠ Ø§Ù„Ø´Ø®ØµÙŠ</strong>
  </div>
  <div id="profilePage">
    <div class="profile-img" id="profileImg"></div>
    <input type="file" id="profileImage">
    <input id="profileName" placeholder="Ø§Ù„Ø§Ø³Ù…">
    <textarea id="profileBio" placeholder="Ø§Ù„Ø¨Ø§ÙŠÙˆ"></textarea>
    <button onclick="saveProfile()">Ø­ÙØ¸</button>
    <button class="danger" onclick="deleteAccount()">Ø­Ø°Ù Ø­Ø³Ø§Ø¨ÙŠ</button>
  </div>
</div>

<!-- Ø§Ù„Ø¥Ø¹Ø¯Ø§Ø¯Ø§Øª -->
<div id="settingsPanel">
  <button onclick="openProfile()">Ù…Ù„ÙÙŠ Ø§Ù„Ø´Ø®ØµÙŠ</button>
  <button onclick="logout()">ØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ø®Ø±ÙˆØ¬</button>
</div>

<script>
firebase.initializeApp({
  apiKey:"AIzaSyAdnzO83yV5sqL6TBrhStdyoxdoKlcR6yY",
  authDomain:"mychatapp-29f33.firebaseapp.com",
  projectId:"mychatapp-29f33",
  storageBucket:"mychatapp-29f33.appspot.com"
});

const auth=firebase.auth();
const db=firebase.firestore();
const storage=firebase.storage();

/* ØµÙØ­Ø§Øª */
const loginPage=document.getElementById("page-login");
const setupNamePage=document.getElementById("page-setup-name");
const listPage=document.getElementById("page-list");
const chatPage=document.getElementById("page-chat");
const profilePage=document.getElementById("page-profile");

/* Ø¹Ù†Ø§ØµØ± */
const list=document.getElementById("list");
const profileName=document.getElementById("profileName");
const profileBio=document.getElementById("profileBio");
const profileImg=document.getElementById("profileImg");
const profileImage=document.getElementById("profileImage");
const imgInput=document.getElementById("imgInput");
const msg=document.getElementById("msg");
const preview=document.getElementById("preview");
const settingsPanel=document.getElementById("settingsPanel");

/* Ù…ØªØºÙŠØ±Ø§Øª */
let currentUser=null;
let chattingWith=null;
let imageFile=null;

/* Ø¥Ø¯Ø§Ø±Ø© Ø§Ù„ØµÙØ­Ø§Øª */
function showPage(p){
  document.querySelectorAll(".page").forEach(x=>x.classList.remove("active"));
  p.classList.add("active");
}

/* ØªØ³Ø¬ÙŠÙ„ Ø¯Ø®ÙˆÙ„ Google */
function loginGoogle(){
  const provider=new firebase.auth.GoogleAuthProvider();
  auth.signInWithPopup(provider).then(r=>{
    currentUser=r.user;
    checkUser();
  }).catch(console.error);
}

/* ØªØ­Ù‚Ù‚ Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù… */
function checkUser(){
  db.collection("users").doc(currentUser.uid).get().then(doc=>{
    if(!doc.exists || !doc.data().name){
      showPage(setupNamePage);
    } else {
      showPage(listPage);
      loadUsers();
    }
  });
}

/* Ø­ÙØ¸ Ø§Ù„Ø§Ø³Ù… Ù„Ø£ÙˆÙ„ Ù…Ø±Ø© */
function submitName(){
  const name=nameInput.value.trim();
  if(!name){alert("Ø§ÙƒØªØ¨ Ø§Ø³Ù…Ùƒ");return;}
  db.collection("users").doc(currentUser.uid).set({name,bio:"",photo:""},{merge:true}).then(()=>{
    showPage(listPage);
    loadUsers();
  });
}

/* ØªØ­Ù…ÙŠÙ„ Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù…ÙŠÙ† */
function loadUsers(){
  list.innerHTML="";
  db.collection("users").onSnapshot(s=>{
    list.innerHTML="";
    s.forEach(d=>{
      if(d.id!==currentUser.uid){
        const div=document.createElement("div");
        div.className="chat-item";
        div.innerHTML=`<div class="avatar"></div>${d.data().name}`;
        div.onclick=()=>{chattingWith=d.id;showPage(chatPage);loadMessages()};
        list.appendChild(div);
      }
    });
  });
}

/* Ø¥Ø±Ø³Ø§Ù„ Ø±Ø³Ø§Ù„Ø© */
function send(){
  if(!msg.value && !imageFile) return;
  const chatId=currentUser.uid>chattingWith?currentUser.uid+"_"+chattingWith:chattingWith+"_"+currentUser.uid;

  if(imageFile){
    const ref=storage.ref("images/"+Date.now());
    const imgLocal = preview.innerHTML; // Ù…Ø¹Ø§ÙŠÙ†Ø© Ù…Ø­Ù„ÙŠØ©
    messages.innerHTML+=imgLocal; // Ø¹Ø±Ø¶ Ù…Ø¤Ù‚Øª
    ref.put(imageFile).then(()=>ref.getDownloadURL().then(url=>{
      db.collection("chats").doc(chatId).collection("messages").add({
        from:currentUser.uid,
        image:url,
        time:firebase.firestore.FieldValue.serverTimestamp()
      });
    }));
    imageFile=null;
    preview.innerHTML="";
  }

  if(msg.value){
    const textLocal = `<div class="msg me">${msg.value}</div>`;
    messages.innerHTML+=textLocal;
    db.collection("chats").doc(chatId).collection("messages").add({
      from:currentUser.uid,
      text:msg.value,
      time:firebase.firestore.FieldValue.serverTimestamp()
    });
    msg.value="";
  }
  messages.scrollTop = messages.scrollHeight;
}

/* ØªØ­Ù…ÙŠÙ„ Ø§Ù„Ø±Ø³Ø§Ø¦Ù„ */
function loadMessages(){
  messages.innerHTML="";
  const chatId=currentUser.uid>chattingWith?currentUser.uid+"_"+chattingWith:chattingWith+"_"+currentUser.uid;
  db.collection("chats").doc(chatId).collection("messages").orderBy("time").onSnapshot(s=>{
    messages.innerHTML="";
    s.forEach(d=>{
      const m=d.data();
      const div=document.createElement("div");
      div.className="msg"+(m.from===currentUser.uid?" me":"");
      if(m.text) div.innerText=m.text;
      if(m.image) div.innerHTML=`<img src="${m.image}">`;
      messages.appendChild(div);
    });
    messages.scrollTop=messages.scrollHeight;
  });
};

/* Ù…Ø¹Ø§ÙŠÙ†Ø© ØµÙˆØ±Ø© Ø§Ù„Ø´Ø§Øª Ù‚Ø¨Ù„ Ø§Ù„Ø¥Ø±Ø³Ø§Ù„ */
imgInput.onchange=e=>{
  imageFile=e.target.files[0];
  const r=new FileReader();
  r.onload=()=>preview.innerHTML=`<img src="${r.result}">`;
  r.readAsDataURL(imageFile);
};

/* Ù…Ø¹Ø§ÙŠÙ†Ø© ØµÙˆØ±Ø© Ø§Ù„Ù…Ù„Ù Ø§Ù„Ø´Ø®ØµÙŠ Ù‚Ø¨Ù„ Ø§Ù„Ø­ÙØ¸ */
profileImage.onchange = e => {
  const file = e.target.files[0];
  if(file){
    const reader = new FileReader();
    reader.onload = () => {
      profileImg.style.backgroundImage = `url(${reader.result})`;
      profileImg.style.backgroundSize = 'cover';
      profileImg.style.backgroundPosition = 'center';
    };
    reader.readAsDataURL(file);
  }
};

/* Ø¥Ø¹Ø¯Ø§Ø¯Ø§Øª */
function toggleSettings(){settingsPanel.style.display=settingsPanel.style.display==="block"?"none":"block";}
function openProfile(){
  settingsPanel.style.display="none";
  db.collection("users").doc(currentUser.uid).get().then(doc=>{
    if(doc.exists){
      profileName.value=doc.data().name||"";
      profileBio.value=doc.data().bio||"";
      if(doc.data().photo) profileImg.style.backgroundImage=`url(${doc.data().photo})`;
    }
  });
  showPage(profilePage);
}

/* Ø­ÙØ¸ Ø§Ù„Ù…Ù„Ù Ø§Ù„Ø´Ø®ØµÙŠ */
function saveProfile(){
  const file = profileImage.files[0];
  if(file){
    const ref=storage.ref("profile/"+currentUser.uid+"_"+Date.now());
    ref.put(file).then(()=>ref.getDownloadURL().then(url=>{
      db.collection("users").doc(currentUser.uid).update({
        name:profileName.value,
        bio:profileBio.value,
        photo:url
      });
      profileImg.style.backgroundImage=`url(${url})`;
      alert("ØªÙ… Ø§Ù„Ø­ÙØ¸");
    }));
  } else {
    db.collection("users").doc(currentUser.uid).update({
      name:profileName.value,
      bio:profileBio.value
    });
    alert("ØªÙ… Ø§Ù„Ø­ÙØ¸");
  }
}

/* Ø­Ø°Ù Ø§Ù„Ø­Ø³Ø§Ø¨ */
function deleteAccount(){
  if(confirm("ØªØ£ÙƒÙŠØ¯ Ø­Ø°Ù Ø§Ù„Ø­Ø³Ø§Ø¨ØŸ")){
    db.collection("users").doc(currentUser.uid).delete().then(()=>{
      currentUser.delete().then(()=>location.reload());
    });
  }
}

/* ØªØ³Ø¬ÙŠÙ„ Ø®Ø±ÙˆØ¬ */
function logout(){auth.signOut().then(()=>location.reload());}
</script>

</body>
</html>