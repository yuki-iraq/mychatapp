<!DOCTYPE html>
<html lang="ar">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>MyChatApp</title>
<!-- Firebase -->
<script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-app-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-auth-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-firestore-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-storage-compat.js"></script>
<style>
*{box-sizing:border-box;margin:0;padding:0;font-family:'Arial',sans-serif}
body{background:#f0f2f5;color:#111;overflow:hidden}
.page{position:fixed;inset:0;display:none;flex-direction:column;transition:all .4s ease;}
.page.active{display:flex;opacity:1;transform:translateX(0);}
.page.animate-in{opacity:0;transform:translateY(50px);}
button{cursor:pointer;transition:all .2s ease;}
button:hover{transform:scale(1.05);box-shadow:0 5px 15px rgba(0,0,0,0.2);}
button:active{transform:scale(0.95);}
img{display:block;}
/* ØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ø¯Ø®ÙˆÙ„ */
#page-login{justify-content:center;align-items:center}
.login-box{width:90%;max-width:360px;background:white;padding:30px;border-radius:15px;box-shadow:0 10px 25px rgba(0,0,0,0.2);text-align:center;transform:translateY(-20px);transition:all .5s ease;}
.login-box h3{margin-bottom:20px;color:#2aabee;}
.login-box button{width:100%;padding:12px;border:none;border-radius:12px;background:#2aabee;color:white;font-size:16px;box-shadow:0 5px 15px rgba(42,171,238,0.4);}

/* Ø´Ø±ÙŠØ· Ø¹Ù„ÙˆÙŠ */
.top{height:55px;background:white;display:flex;align-items:center;justify-content:space-between;padding:0 15px;box-shadow:0 4px 10px rgba(0,0,0,0.1);border-bottom:1px solid #ccc;border-radius:0 0 15px 15px}
.top span{cursor:pointer;font-size:22px}

/* Ù‚Ø§Ø¦Ù…Ø© Ø§Ù„Ù…Ø­Ø§Ø¯Ø«Ø§Øª */
#list{flex:1;overflow-y:auto;padding:10px;background:#f9fafc;}
.chat-item{display:flex;align-items:center;padding:12px;margin-bottom:8px;background:white;border-radius:12px;box-shadow:0 5px 15px rgba(0,0,0,0.05);cursor:pointer;transition:all .3s ease;}
.chat-item:hover{transform:translateX(5px);box-shadow:0 10px 20px rgba(0,0,0,0.1);}
.avatar{width:50px;height:50px;border-radius:50%;background:#ccc;margin-left:10px;object-fit:cover;box-shadow:0 3px 10px rgba(0,0,0,0.1);}
.chat-name{font-weight:bold;}
.unread{background:red;color:white;border-radius:50%;padding:2px 6px;margin-left:5px;font-size:12px;}
.last-seen{font-size:12px;color:#666;}

/* Ø§Ù„Ø´Ø§Øª */
#messages{flex:1;overflow-y:auto;padding:10px;background:#f1f3f6;}
.msg{max-width:70%;padding:10px;margin:5px 0;border-radius:12px;background:white;box-shadow:0 5px 15px rgba(0,0,0,0.05);word-break:break-word;animation:fadeIn .4s;}
.me{background:#2aabee;color:white;margin-left:auto;box-shadow:0 5px 15px rgba(42,171,238,0.3);}
.msg img{max-width:100%;border-radius:12px;box-shadow:0 5px 15px rgba(0,0,0,0.1);}

/* Ø¥Ø¯Ø®Ø§Ù„ */
.input-bar{background:white;padding:8px;display:flex;gap:5px;box-shadow:0 -4px 10px rgba(0,0,0,0.05);border-radius:15px 15px 0 0;}
.input-bar input[type=text]{flex:1;padding:10px;border:none;border-radius:12px;box-shadow:0 5px 15px rgba(0,0,0,0.05);}
.input-bar button{border:none;border-radius:12px;background:#2aabee;color:white;padding:0 15px;box-shadow:0 5px 15px rgba(42,171,238,0.3);}
#preview{display:flex;padding:5px}
#preview img{width:70px;border-radius:12px;object-fit:cover;box-shadow:0 5px 15px rgba(0,0,0,0.1);}

/* Ø¥Ø¹Ø¯Ø§Ø¯Ø§Øª */
#settingsPanel{position:fixed;top:70px;right:10px;background:white;border-radius:15px;padding:15px;display:none;flex-direction:column;box-shadow:0 10px 25px rgba(0,0,0,0.2);}
#settingsPanel button{background:none;border:none;color:#2aabee;margin:5px 0;text-align:left;font-weight:bold;}
#profilePic{width:50px;height:50px;border-radius:50%;object-fit:cover;box-shadow:0 5px 15px rgba(0,0,0,0.1);}
#profileName{font-weight:bold;color:#2aabee;margin-left:8px;}

/* ØµÙØ­Ø© ØªØ¹Ø¯ÙŠÙ„ Ø§Ù„Ù…Ù„Ù Ø§Ù„Ø´Ø®ØµÙŠ */
#profilePage{position:fixed;inset:0;background:white;display:none;flex-direction:column;padding:20px;overflow:auto;animation:slideIn .5s;}
#profilePage h3{color:#2aabee;margin-bottom:20px;}
#profilePage input[type=text],#profilePage textarea{width:100%;padding:10px;margin-bottom:15px;border-radius:12px;border:1px solid #ccc;}
#profilePage button{width:100%;padding:12px;border:none;border-radius:12px;background:#2aabee;color:white;font-size:16px;margin-top:10px;}

/* Ø£Ù†ÙŠÙ…ÙŠØ´Ù† */
@keyframes fadeIn{0%{opacity:0;transform:translateY(10px);}100%{opacity:1;transform:translateY(0);}}
@keyframes slideIn{0%{opacity:0;transform:translateY(100px);}100%{opacity:1;transform:translateY(0);}}
</style>
</head>
<body>
<!-- ØµÙØ­Ø© ØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ø¯Ø®ÙˆÙ„ -->
<div id="page-login" class="page active">
  <div class="login-box">
    <h3>ØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ø¯Ø®ÙˆÙ„</h3>
    <button onclick="loginGoogle()">ØªØ³Ø¬ÙŠÙ„ Ø¯Ø®ÙˆÙ„ Google G</button>
  </div>
</div>

<!-- ØµÙØ­Ø© Ù‚Ø§Ø¦Ù…Ø© Ø§Ù„Ù…Ø­Ø§Ø¯Ø«Ø§Øª -->
<div id="page-list" class="page">
  <div class="top">
    <strong>MyChatApp</strong>
    <span onclick="toggleSettings()">âš™ï¸</span>
  </div>
  <div id="list"></div>
</div>

<!-- ØµÙØ­Ø© Ø§Ù„Ø´Ø§Øª -->
<div id="page-chat" class="page">
  <div class="top">
    <span onclick="showList()">â¬…</span>
    <strong>Ø§Ù„Ø¯Ø±Ø¯Ø´Ø©</strong>
    <button style="background:#2aabee;color:white;border:none;border-radius:12px;padding:5px 10px;" onclick="callUser()">ğŸ“ Ø§ØªØµØ§Ù„</button>
  </div>
  <div id="messages"></div>
  <div id="preview"></div>
  <div class="input-bar">
    <input type="file" id="imgInput" hidden accept="image/*">
    <button onclick="imgInput.click()">ğŸ“·</button>
    <input type="text" id="msg" placeholder="Ø§ÙƒØªØ¨ Ø±Ø³Ø§Ù„Ø©...">
    <button onclick="send()">â¤</button>
  </div>
</div>

<!-- Ø§Ù„Ø¥Ø¹Ø¯Ø§Ø¯Ø§Øª -->
<div id="settingsPanel">
  <div style="display:flex;align-items:center;gap:5px;margin-bottom:10px">
    <img id="profilePic" src="#">
    <span id="profileName"></span>
  </div>
  <button onclick="openProfile()">ØªØ¹Ø¯ÙŠÙ„ Ø§Ù„Ù…Ù„Ù Ø§Ù„Ø´Ø®ØµÙŠ</button>
  <button onclick="logout()">ØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ø®Ø±ÙˆØ¬</button>
</div>

<!-- ØµÙØ­Ø© ØªØ¹Ø¯ÙŠÙ„ Ø§Ù„Ù…Ù„Ù Ø§Ù„Ø´Ø®ØµÙŠ -->
<div id="profilePage">
  <h3>ØªØ¹Ø¯ÙŠÙ„ Ø§Ù„Ù…Ù„Ù Ø§Ù„Ø´Ø®ØµÙŠ</h3>
  <input type="text" id="newName" placeholder="Ø§Ù„Ø§Ø³Ù…">
  <textarea id="newBio" placeholder="Ø§Ù„Ø¨Ø§ÙŠÙˆ"></textarea>
  <input type="file" id="newPic" accept="image/*">
  <button onclick="saveProfile()">Ø­ÙØ¸ Ø§Ù„ØªØ¹Ø¯ÙŠÙ„Ø§Øª</button>
  <button onclick="closeProfile()">Ø¥ØºÙ„Ø§Ù‚</button>
</div>

<script>
firebase.initializeApp({
  apiKey:"AIzaSyAdnzO83yV5sqL6TBrhStdyoxdoKlcR6yY",
  authDomain:"mychatapp-29f33.firebaseapp.com",
  projectId:"mychatapp-29f33",
  storageBucket:"mychatapp-29f33.appspot.com"
});
const auth=firebase.auth();
const db=firebase.firestore();
const storage=firebase.storage();

const loginPage=document.getElementById("page-login");
const listPage=document.getElementById("page-list");
const chatPage=document.getElementById("page-chat");
const settingsPanel=document.getElementById("settingsPanel");
const profilePage=document.getElementById("profilePage");
const profilePic=document.getElementById("profilePic");
const profileName=document.getElementById("profileName");
let currentUser=null,chattingWith=null,imageFile=null;

function showPage(p){[loginPage,listPage,chatPage].forEach(x=>x.classList.remove("active"));p.classList.add("active");}

function loginGoogle(){
  const provider=new firebase.auth.GoogleAuthProvider();
  auth.signInWithPopup(provider).then(r=>{
    currentUser=r.user;
    db.collection("users").doc(currentUser.uid).set({
      name:currentUser.displayName,
      photo:currentUser.photoURL,
      bio:""
    },{merge:true});
    profilePic.src=currentUser.photoURL;
    profileName.innerText=currentUser.displayName;
    showPage(listPage);
    loadUsers();
  });
}

function loadUsers(){
  const list=document.getElementById("list");
  const addedUsers = new Set(); // <-- Ø­Ù„ ØªÙƒØ±Ø§Ø± Ø§Ù„Ø­Ø³Ø§Ø¨Ø§Øª
  list.innerHTML="";
  db.collection("users").onSnapshot(s=>{
    list.innerHTML="";
    s.forEach(d=>{
      if(d.id!==currentUser.uid && !addedUsers.has(d.id)){
        const data=d.data();
        const div=document.createElement("div");
        div.className="chat-item";
        div.innerHTML=`<div class="avatar" style="background-image:url('${data.photo}')"></div><div><div class="chat-name">${data.name}<span class='unread' id='unread_${d.id}'>0</span></div></div>`;
        div.onclick=()=>openChat(d.id);
        list.appendChild(div);
        addedUsers.add(d.id);
      }
    });
  });
}

function openChat(uid){chattingWith=uid;showPage(chatPage);loadMessages();}
function showList(){showPage(listPage);}

function send(){
  if(!msg.value&&!imageFile)return;
  const chatId=currentUser.uid>chattingWith?currentUser.uid+"_"+chattingWith:chattingWith+"_"+currentUser.uid;
  if(imageFile){
    const ref=storage.ref("images/"+Date.now());
    ref.put(imageFile).then(()=>ref.getDownloadURL().then(url=>{
      db.collection("chats").doc(chatId).collection("messages").add({from:currentUser.uid,image:url,time:firebase.firestore.FieldValue.serverTimestamp()});
    }));
    imageFile=null;preview.innerHTML="";
  }
  if(msg.value){
    db.collection("chats").doc(chatId).collection("messages").add({from:currentUser.uid,text:msg.value,time:firebase.firestore.FieldValue.serverTimestamp()});
    msg.value="";
  }
}

function loadMessages(){
  messages.innerHTML="";
  const chatId=currentUser.uid>chattingWith?currentUser.uid+"_"+chattingWith:chattingWith+"_"+currentUser.uid;
  db.collection("chats").doc(chatId).collection("messages").orderBy("time").onSnapshot(s=>{
    messages.innerHTML="";
    s.forEach(d=>{
      const m=d.data();
      const div=document.createElement("div");
      div.className="msg"+(m.from===currentUser.uid?" me":"");
      if(m.text)div.innerText=m.text;
      if(m.image)div.innerHTML=`<img src='${m.image}'>`;
      messages.appendChild(div);
    });
    messages.scrollTop=messages.scrollHeight;
  });
}

imgInput.onchange=e=>{
  imageFile=e.target.files[0];
  const r=new FileReader();
  r.onload=()=>preview.innerHTML=`<img src='${r.result}'>`;
  r.readAsDataURL(imageFile);
};

function toggleSettings(){settingsPanel.style.display=settingsPanel.style.display==="flex"?"none":"flex";}
function openProfile(){profilePage.style.display="flex";settingsPanel.style.display="none";}
function closeProfile(){profilePage.style.display="none";}
function saveProfile(){
  const newName=document.getElementById("newName").value||currentUser.displayName;
  const newBio=document.getElementById("newBio").value||"";
  const newPicFile=document.getElementById("newPic").files[0];
  if(newPicFile){
    const ref=storage.ref("profile/"+Date.now());
    ref.put(newPicFile).then(()=>ref.getDownloadURL().then(url=>{
      db.collection("users").doc(currentUser.uid).update({name:newName,bio:newBio,photo:url});
      profileName.innerText=newName;profilePic.src=url;
      alert("ØªÙ… Ø§Ù„Ø­ÙØ¸");
      closeProfile();
    }));
  } else {
    db.collection("users").doc(currentUser.uid).update({name:newName,bio:newBio});
    profileName.innerText=newName;alert("ØªÙ… Ø§Ù„Ø­ÙØ¸");closeProfile();
  }
}
function logout(){auth.signOut().then(()=>location.reload());}
function callUser(){alert("Ù…ÙŠØ²Ø© Ø§Ù„Ø§ØªØµØ§Ù„ ØªØ¹Ù…Ù„!");}

auth.onAuthStateChanged(user=>{
  if(user){
    currentUser=user;
    profilePic.src=user.photoURL;
    profileName.innerText=user.displayName;
    showPage(listPage);
    loadUsers();
  }else showPage(loginPage);
});
</script>
</body>
</html>